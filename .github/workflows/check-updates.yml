name: Check resource updates of packages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  collect-packages:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - run: pipx install pipenv
      - uses: actions/setup-python@v4
        with:
          architecture: x64
          python-version: '3.10'
          cache: pipenv
      - run: pipenv install
      - name: Collect packages from target folders
        id: collect
        run: |
          pipenv run ./tools/collect-packages.py ./packages
    outputs:
      packages: ${{ steps.collect.outputs.packages }}
  check-package:
    needs:
      - collect-packages
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.collect-packages.outputs.packages) }}
    steps:
      - uses: actions/checkout@v3
      - run: pipx install pipenv
      - uses: actions/setup-python@v4
        with:
          architecture: x64
          python-version: '3.10'
          cache: pipenv
      - run: pipenv install
      - name: Try update version
        id: updating
        run: |
          pipenv run ./tools/try-update-sources.py packages/${{ matrix.package }}
      - name: Create Pull Request
        if: steps.updating.outputs.current != steps.updating.outputs.latest
        uses: peter-evans/create-pull-request@v4
        with:
          branch: update/${{ matrix.package }}/${{ steps.updating.outputs.latest }}
          commit-message: "Update package-info of ${{ matrix.package }}"
          title: "Update package-info of ${{ matrix.package }} from ${{ steps.updating.outputs.current }} to ${{ steps.updating.outputs.latest }}"
          delete-branch: true
          body: |
            *Auto-generated by GitHub Actions*
